services:
  # Mock Jamulus JSON-RPC Server
  mock-jamulus:
    image: node:20.10.0-alpine
    working_dir: /app
    command: node mock-jamulus-server.mjs
    volumes:
      - .:/app
    environment:
      JAMULUS_HOST: 0.0.0.0
      JAMULUS_PORT: 22222
      JAMULUS_SECRET: test-secret-1234567890
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "22222"]
      interval: 2s
      timeout: 5s
      retries: 10

  # API Gateway (the application being tested)
  gateway:
    image: jamulus-json-rpc-api-gateway:test
    environment:
      PORT: 3434
      LISTEN_HOST: 0.0.0.0
      JAMULUS_SECRET: test-secret-1234567890
      JAMULUS_HOST: mock-jamulus
      JAMULUS_PORT: 22222
      API_KEYS: test-api-key-123,another-api-key-456
      JWT_PUBLIC_KEY: LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUNvd0JRWURLMlZ3QXlFQTZFdmh1cnlkYmlSOWZGQThWVEM0RFBGYjMzZk13aWV5dnphZTZyTjNxajQ9Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo=
    networks:
      - test-network
    depends_on:
      mock-jamulus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3434/"]
      interval: 2s
      timeout: 5s
      retries: 10

  # Test Runner
  test-runner:
    image: node:20.10.0-alpine
    working_dir: /app
    command: sh -c "npm install jose && node --test acceptance.test.mjs"
    volumes:
      - .:/app
    environment:
      GATEWAY_URL: http://gateway:3434
      API_KEY: test-api-key-123
      JWT_PRIVATE_KEY_BASE64: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1DNENBUUF3QlFZREsyVndCQ0lFSUM4MFNBZ05TSlF2MTM2a2tpSjZEL3R0N0ZoZ2RFRndnRHZNcElONWgwT0gKLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=
    networks:
      - test-network
    depends_on:
      gateway:
        condition: service_healthy

networks:
  test-network:
    driver: bridge
